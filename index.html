<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Doorprize App</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>


    <style>
        :root {
            --primary: #0f172a;
            /* navy */
            --secondary: #334155;
            /* slate */
            --accent: #f59e0b;
            /* gold */
            --bg: #f8fafc;

            --card-font: 1rem;
            --card-width: 180px;
            --card-padding: 0.3rem;
        }

        body {
            background: linear-gradient(180deg, #f8fafc, #eef2f7);
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            color: #0f172a;
            min-height: 100vh;
        }

        /* ===== HEADINGS ===== */
        h5,
        h6 {
            letter-spacing: 0.5px;
        }

        /* ===== PARTICIPANT LIST ===== */
        .participant-container {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
        }

        .card-participant {
            width: var(--card-width);
            font-size: 0.95rem;
            padding: 0.4rem;
            border-radius: 12px;
            background: linear-gradient(180deg, #ffffff, #f8fafc);
            border: 1px solid #e2e8f0;
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
            transition: all .25s ease;
        }

        .card-participant .card-body {
            font-weight: 600;
            white-space: nowrap;
            /* 1 baris */
            overflow: hidden;
            /* sembunyikan sisanya */
            text-overflow: ellipsis;
            /* ... */
            text-align: center;
        }



        .card-participant:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
        }

        .card-participant .card-body {
            font-weight: 600;
        }

        /* ===== SHUFFLE EFFECT ===== */
        .shuffle {
            background: linear-gradient(135deg, #fde68a, #fbbf24);
            color: #78350f;
            border: 1px solid #f59e0b;
            animation: pulse 0.3s infinite;
        }

        #nextPrizeBtn {
            padding: 0.9rem 3rem;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        @keyframes pulse {
            50% {
                transform: scale(1.03);
            }
        }

        /* ===== BUTTONS ===== */
        .btn {
            border-radius: 12px;
            font-weight: 600;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            border: none;
        }

        .btn-success:disabled {
            background: #cbd5e1;
            color: #475569;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            border: none;
            color: #78350f;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            border: none;
        }

        .btn-dark {
            background: linear-gradient(135deg, #020617, #0f172a);
            border: none;
        }

        /* ===== TEXTAREA ===== */
        textarea {
            border-radius: 14px;
            border: 1px solid #cbd5e1;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, .04);
        }

        /* ===== WINNER SIDEBAR ===== */
        #winnerList {
            max-height: 60vh;
            overflow-y: scroll;
        }

        #winnerList .card {
            border-radius: 14px;
            border: none;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
        }

        #winnerList .card-header {
            background: linear-gradient(135deg, #020617, #0f172a);
            color: #fbbf24;
            font-weight: 700;
            text-align: center;
            letter-spacing: 1px;
        }

        #winnerList .card-body div {
            font-size: 0.9rem;
            padding: 3px 0;
        }

        /* ===== FULLSCREEN OVERLAY ===== */
        #winnerOverlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, #020617, #000);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #f8fafc;
            padding-top: 4rem;
        }

        #winnerOverlay h2 {
            font-size: 2.2rem;
        }

        .winner-name {
            font-size: 6rem;
            font-weight: 900;
            letter-spacing: 3px;
            color: #fbbf24;
        }

        #winnerAll {
            font-size: 2rem;
            opacity: 0.9;
        }

        /* ===== MC MODE ===== */
        /* .mc-mode .card-participant {
            font-size: 1.6rem;
        } */

        /* .mc-mode h5,
        .mc-mode h6 {
            font-size: 2.2rem;
        } */

        /* ===== AUDIENCE MODE ===== */
        .audience-mode #nameInput,
        .audience-mode #saveBtn,
        .audience-mode .col-3 {
            display: none !important;
        }

        /* Lebarkan area peserta */
        .audience-mode .col-7 {
            width: 85%;
        }

        .audience-mode .col-2 {
            width: 15%;
        }

        /* Perbesar kartu peserta */
        /* .audience-mode .card-participant {
            font-size: 2rem;
            padding: 1.5rem;
        } */

        /* Judul lebih besar */
        /* .audience-mode h5,
        .audience-mode h6 {
            font-size: 2.5rem;
        } */
        .letter-spacing {
            letter-spacing: 3px;
        }

        .fullscreen-winner {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, #1e1e1e, #000);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .fullscreen-winner.hidden {
            display: none;
        }

        .winner-content {
            text-align: center;
            color: #fff;
            width: 90%;
        }

        #wfCategory,
        #fwCategory {
            font-size: 48px;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        .photo-overlay {
            position: fixed;
            inset: 0;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        /* ===== AREA FOTO (90%) ===== */
        .photo-content {
            flex: 0 0 90%;
            background: radial-gradient(circle at top, #020617, #000);
            padding: 4rem 5rem;
            color: #f8fafc;
            overflow: hidden;
        }

        /* ===== HEADER ===== */
        .photo-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        #photoCategory {
            font-size: 3rem;
            font-weight: 800;
            letter-spacing: 3px;
            color: #fbbf24;
        }

        /* ===== FLEX NAMA ===== */
        .photo-names {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: flex-start;
            gap: 2rem;

        }

        /* ===== CARD NAMA ===== */
        .photo-name {
            font-size: 2.5rem;
            font-weight: 700;
            padding: 1.5rem 2.5rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(6px);
            white-space: nowrap;
        }

        /* ===== FOOTER (10%) ===== */
        .photo-footer {
            flex: 0 0 10%;
            /* background: #020617; */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* cursor NORMAL */
        .photo-overlay {
            cursor: default;
        }

        .photo-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 40px;
        }

        .center-title {
            text-align: center;
            flex: 1;
        }

        /* FIXED TEXT */
        .fixed-top-right {
            position: fixed;
            top: 20px;
            right: 30px;
            z-index: 9999;

            text-align: right;
            color: #fff;
            font-weight: 600;
            line-height: 1.2;
        }

        /* OPTIONAL biar kontras di foto */
        .fixed-top-right h5 {
            background: rgba(0, 0, 0, 0.45);
            padding: 8px 12px;
            border-radius: 10px;
            margin: 0;
        }

        .fixed-top-left {
            position: fixed;
            top: 20px;
            left: 30px;
            z-index: 9999;

            text-align: left;
            color: #fff;

        }

        .logo-outline {
            filter: drop-shadow(0 0 0 #ffffff) drop-shadow(0 0 3px #ffffff) drop-shadow(0 0 6px #ffffff);
        }
    </style>
</head>

<body>

    <!-- AUDIO -->
    <audio id="drumSound" src="drum_roll.mp3"></audio>
    <audio id="winSound" src="single_fireworks.mp3"></audio>

    <!-- FULLSCREEN OVERLAY -->
    <div id="winnerOverlay" class="text-center">
        <h2 class="mb-4" id="selamat-kepada"> Selamat Kepada: </h2>
        <div id="winnerName" class="winner-name"></div>
        <div id="winnerAll" class="mt-4 fs-3 fw-semibold"></div>

        <button class="btn btn-light mt-4 d-none" id="btn-close-overlay" onclick="closeOverlay()">Tutup</button>
    </div>

    <div id="photoOverlay" class="photo-overlay d-none" onclick="closePhotoOverlay()">
        <div class="photo-content">
            <div class="left-logo logo-outline fixed-top-left">
                <img src="https://mandiricoal.co.id/wp-content/uploads/2019/02/section-mandiricoal-logo.png"
                    height="100" alt="">
            </div>
            <div class="photo-header">

                <div class="center-title">
                    <h3>Selamat Kepada Pemenang Doorprize</h3>
                    <div id="photoCategory"></div>
                </div>
            </div>

            <!-- FIXED TEXT -->
            <div class="fixed-top-right">
                <h5>Outing Bintan ‚Äì 2026 ‚Äì Mandiri Coal</h5>
            </div>

            <div id="photoNames" class="photo-names"></div>
        </div>

        <div class="photo-footer">

        </div>
    </div>

    <div class="p-3">
        <div class="d-flex justify-content-between gap-3 mb-4">
            <div class="text-center col-11">
                <img src="https://mandiricoal.co.id/wp-content/uploads/2019/02/section-mandiricoal-logo.png" height="60"
                    alt="">
                <h2 class="fw-bold text-uppercase letter-spacing">
                    Doorprize Night
                </h2>
                <div class="d-flex flex-column align-items-center mt-3">
                    <button id="nextPrizeBtn" class="btn btn-lg btn-warning ms-2 mb-2" onclick="nextPrize()" disabled>
                        ‚è≠Ô∏è SPIN DOORPRIZE
                    </button>

                    <div id="nextPrizeInfo" class="fw-semibold text-secondary">
                        üéÅ Doorprize selanjutnya: -
                    </div>
                </div>
            </div>
            <!-- <button class="btn btn-outline-secondary me-2" onclick="toggleAudience()">
                üë• Audience Mode
            </button> -->
            <div class="col-1">
                <button class="btn btn-dark text-end" onclick="toggleMC()">üì∫ Full Screen</button>

            </div>
        </div>

        <div class="row">

            <!-- COL 3 INPUT -->
            <div class="col-3">
                <h5 class="fw-bold text-primary">Peserta</h5>
                <textarea id="nameInput" class="form-control mb-2" rows="15" placeholder="1 baris = 1 nama"></textarea>

                <button id="saveBtn" class="btn btn-primary w-100 mb-2">üíæ Save Peserta</button>
                <button class="btn btn-danger w-100" onclick="resetAll()">üîÑ Reset Semua</button>
            </div>

            <!-- COL 7 PESERTA -->
            <div class="col-7">
                <h5 class="fw-bold">Daftar Peserta [Total : <d id="totalPeserta">0</d>]</h5>
                <div id="participantList" class="participant-container mb-3"></div>

                <!-- <div class="d-flex justify-content-center flex-wrap gap-2">
                    <button class="btn btn-success drawPrizeButton" id="drawPrize1">üéÅ Doorprize 1</button>
                    <button class="btn btn-success drawPrizeButton" id="drawPrize2">üéÅ Doorprize 2</button>
                    <button class="btn btn-success drawPrizeButton" id="drawPrize3">üéÅ Doorprize 3</button>
                    <button class="btn btn-success drawPrizeButton" id="drawPrize4">üéÅ Doorprize 4</button>
                    <button class="btn btn-success drawPrizeButton" id="drawPrize5">üéÅ Doorprize 5</button>

                </div> -->

            </div>

            <!-- COL 2 WINNERS -->
            <div class="col-2">
                <h6 class="fw-bold text-center">üèÜ Pemenang</h6>

                <button class="btn btn-sm btn-outline-success w-100 mb-2" onclick="exportWinners()">
                    üì§ Export Pemenang
                </button>

                <div id="winnerList"></div>
            </div>

        </div>
    </div>
    <div id="fullscreenWinner" class="fullscreen-winner hidden">
        <div class="winner-content">
            <h1 id="fwCategory"></h1>

            <div id="fwNames" class="winner-names"></div>

            <button class="btn-close" onclick="closeWinnerFullscreen()">
                Tutup
            </button>
        </div>
    </div>
    <div class="d-flex justify-content-between">

    </div>
    <!-- tombol hapus pemenang -->
    <!-- <button class="btn btn-sm btn-outline-danger px-2 py-0"
                            title="Tidak Hadir"
                            onclick="removeWinner(${cfg.id}, '${n}')">
                            ‚úï
                        </button> -->
    <script>
        const STORAGE_TEXT = 'dp_text';
        const STORAGE_WINNER = 'dp_winners';
        const STORAGE_ORIGINAL = 'dp_original_text';
        const STORAGE_STATE = 'dp_state';

        let currentPrizeIndex = 0;
        let currentSpin = 0;


        const prizeConfig = [
            { id: 1, label: '500.000', total: 16, spins: 2, perSpin: 8 },
            { id: 2, label: '600.000', total: 12, spins: 2, perSpin: 6 },
            { id: 3, label: '700.000', total: 10, spins: 2, perSpin: 5 },
            { id: 4, label: '800.000', total: 8, spins: 1, perSpin: 8 },
            { id: 5, label: '900.000', total: 6, spins: 1, perSpin: 6 },
            { id: 6, label: '1.000.000', total: 4, spins: 1, perSpin: 4 },
            { id: 7, label: '1.550.000', total: 2, spins: 1, perSpin: 2 },
            { id: 8, label: '1.750.000', total: 1, spins: 1, perSpin: 1 },
            { id: 9, label: '2.150.000', total: 1, spins: 1, perSpin: 1 }
        ];



        let isDrawing = false;

        function parseNames(text) {
            return text.split('\n').map(n => n.trim()).filter(n => n);
        }

        function renderParticipants() {
            getTotalParticipants();
            const names = parseNames($('#nameInput').val());
            const el = $('#participantList').empty();
            names.forEach(n => {
                el.append(`<div class="card card-participant shadow-sm">
            <div class="card-body text-center">${n}</div></div>`);
            });
            ;
        }

        function renderWinners() {
            const data = JSON.parse(localStorage.getItem(STORAGE_WINNER)) || {};
            const el = $('#winnerList').empty();
            if (hasWinner()) {
                lockParticipantInput();
            } else {
                unlockParticipantInput();
            }

            Object.keys(prizeConfig).forEach(p => {
                let cfg = prizeConfig[p];
                let winners = data[cfg.id] || [];

                el.append(`
        <div class="card mb-2">
            <div class="card-header fw-bold">
                <div class="d-flex justify-content-between">
                   <small class=""> ${cfg.total} orang | Rp. ${cfg.label} </small>
    
                      <button
        class="btn btn-sm btn-outline-warning border-0 px-1 py-0"
        onclick="showPhotoOverlay(${cfg.id})">
        üì∏
    </button>

    </div>
            </div>
            <div class="card-body p-2">
                ${winners.map((n, i) => `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span>${i + 1}. ${n}</span>
                        
                    </div>
                `).join('')}
            </div>
        </div>`);
            });
        }

        function removeWinner(prizeId, name) {
            if (!confirm(`"${name}" tidak hadir?\nSpin ulang 1 nama?`)) return;

            let winners = JSON.parse(localStorage.getItem(STORAGE_WINNER)) || {};
            let participants = parseNames($('#nameInput').val());

            // hapus pemenang lama
            winners[prizeId] = (winners[prizeId] || []).filter(n => n !== name);
            localStorage.setItem(STORAGE_WINNER, JSON.stringify(winners));

            // lakukan spin ulang
            spinForSingleWinner(participants, (newWinner, updatedParticipants) => {

                // simpan peserta terbaru
                $('#nameInput').val(updatedParticipants.join('\n'));
                localStorage.setItem(STORAGE_TEXT, updatedParticipants.join('\n'));

                // simpan pemenang baru
                if (!winners[prizeId]) winners[prizeId] = [];
                winners[prizeId].push(newWinner);
                localStorage.setItem(STORAGE_WINNER, JSON.stringify(winners));

                renderParticipants();
                renderWinners();

                // tampilkan overlay pemenang
                const prizeLabel = prizeConfig.find(p => p.id === prizeId).label;
                showFullscreenWinners([newWinner], prizeLabel);
            });
        }


        function spinForSingleWinner(participants, callback) {
            if (participants.length === 0) {
                alert('Peserta habis');
                return;
            }

            $('#drumSound')[0].play();

            let shuffleInterval = setInterval(() => {
                $('.card-participant')
                    .removeClass('shuffle')
                    .eq(Math.floor(Math.random() * participants.length))
                    .addClass('shuffle');
            }, 100);

            setTimeout(() => {
                clearInterval(shuffleInterval);
                $('.card-participant').removeClass('shuffle');

                const idx = Math.floor(Math.random() * participants.length);
                const winner = participants[idx];
                participants.splice(idx, 1);

                callback(winner, participants);
            }, 4000); // durasi spin
        }


        function drawCurrentPrize() {
            $('#selamat-kepada').show();
            if (isDoubleFinalPrize()) {
                drawDoubleFinalPrize();
                return;
            }
            if (isDrawing) return;
            isDrawing = true;

            const prize = prizeConfig[currentPrizeIndex];
            if (!prize) {
                alert('Semua doorprize selesai üéâ');
                return;
            }

            let names = parseNames($('#nameInput').val());
            if (names.length < prize.perSpin) {
                alert('Peserta tidak mencukupi');
                isDrawing = false;
                return;
            }

            $('#drumSound')[0].play();

            // animasi shuffle
            let shuffleInterval = setInterval(() => {
                $('.card-participant')
                    .removeClass('shuffle')
                    .eq(Math.floor(Math.random() * names.length))
                    .addClass('shuffle');
            }, 100);

            setTimeout(() => {
                clearInterval(shuffleInterval);

                let winners = [];
                for (let i = 0; i < prize.perSpin; i++) {
                    const idx = Math.floor(Math.random() * names.length);
                    winners.push(names[idx]);
                    names.splice(idx, 1);
                }

                // update peserta
                $('#nameInput').val(names.join('\n'));
                localStorage.setItem(STORAGE_TEXT, names.join('\n'));

                // simpan winner
                let all = JSON.parse(localStorage.getItem(STORAGE_WINNER)) || {};
                if (!all[prize.id]) all[prize.id] = [];
                all[prize.id].push(...winners);

                localStorage.setItem(STORAGE_WINNER, JSON.stringify(all));

                renderParticipants();
                renderWinners();

                showFullscreenWinners(winners, prize.label);

                // update spin
                currentSpin++;
                if (currentSpin >= prize.spins) {
                    currentSpin = 0;
                    currentPrizeIndex++;
                }
                localStorage.setItem(STORAGE_STATE, JSON.stringify({
                    currentSpin,
                    currentPrizeIndex
                }));
                console.log(currentSpin);
                console.log(currentPrizeIndex);

                $('#nextPrizeBtn').prop('disabled', false);
                updateNextPrizeInfo();
                isDrawing = false;

            }, 5000);
        }

        function showFullscreenWinners(winners, label) {
            $('#btn-close-overlay').addClass('d-none');

            let i = 0;
            $('#winnerOverlay').fadeIn();
            $('#winnerName').text('');
            $('#winnerAll').html('');
            // $('#winnerAll').append(`<div class="mb-3">üí∞ Rp ${label}</div>`);

            const winSound = $('#winSound')[0];

            launchConfetti();
            winSound.currentTime = 0;
            winSound.play();
            $('#winnerName').text(winners[i]);
            i++;

            // === NAMA BERIKUTNYA PAKAI INTERVAL ===
            let interval = setInterval(() => {
                if (i >= winners.length) {
                    clearInterval(interval);

                    $('#winnerAll').append(
                        winners.map(n => `<div>üèÜ ${n}</div>`).join('')
                    );
                    $('#winnerName').text('');
                    $('#winnerAll').append(`<div class="mt-5"><span style='font-size:14px;'>Mendapatkan doorprize</span><br>üí∞ Rp ${label}</div>`);
                    $('#btn-close-overlay').removeClass('d-none');
                    return;
                }

                launchConfetti();
                winSound.currentTime = 0;
                winSound.play();

                $('#winnerName').text(winners[i]);
                i++;
            }, 3000);


        }



        function closeOverlay() {
            stopAllSounds();
            $('#winnerOverlay').fadeOut();
        }

        function resetAll() {
            stopAllSounds();
            if (!confirm('Yakin reset semua data?')) return;

            currentPrizeIndex = 0;
            currentSpin = 0;
            localStorage.setItem(STORAGE_STATE, JSON.stringify({
                currentSpin,
                currentPrizeIndex
            }));
            $('#nextPrizeBtn').prop('disabled', false);

            const original = localStorage.getItem(STORAGE_ORIGINAL) || '';
            localStorage.removeItem(STORAGE_WINNER);
            localStorage.setItem(STORAGE_TEXT, original);

            $('#nameInput').val(original);
            renderParticipants();
            renderWinners();
            disableUsedButtons();
            unlockParticipantInput();
            updateNextPrizeInfo();
        }





        $('#saveBtn').click(() => {
            const text = $('#nameInput').val();

            // data aktif
            localStorage.setItem(STORAGE_TEXT, text);

            // baseline reset (SELALU UPDATE)
            localStorage.setItem(STORAGE_ORIGINAL, text);

            // reset hasil doorprize karena data berubah
            localStorage.removeItem(STORAGE_WINNER);
            currentPrize = 0;

            renderParticipants();
            renderWinners();
            disableUsedButtons();
            updateNextPrizeInfo();
            $('#nextPrizeBtn').prop('disabled', false);
        });


        $(document).ready(() => {
            const state = JSON.parse(localStorage.getItem(STORAGE_STATE));
            if (state) {
                currentSpin = state.currentSpin || 0;
                currentPrizeIndex = state.currentPrizeIndex || 0;
            }

            $('#nameInput').val(localStorage.getItem(STORAGE_TEXT) || '');
            renderParticipants();
            renderWinners();
            disableUsedButtons();
            updateNextPrizeInfo();
            $('#nextPrizeBtn').prop('disabled', false);
            if (hasWinner()) {
                lockParticipantInput();
            }

        });
        function disableUsedButtons() {
            const winners = JSON.parse(localStorage.getItem(STORAGE_WINNER)) || {};

            // reset dulu semua tombol
            for (let i = 1; i <= 5; i++) {
                $(`button#drawPrize${i}`)
                    .prop('disabled', false)
                    .removeClass('btn-secondary')
                    .addClass('btn-success');
            }

            // disable yang sudah dipakai
            Object.keys(winners).forEach(p => {
                $(`button#drawPrize${p}`)
                    .prop('disabled', true)
                    .removeClass('btn-success')
                    .addClass('btn-secondary');
            });
        }


        function toggleMC() {
            $('body').toggleClass('mc-mode');

            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
            toggleAudience();
        }

        function launchConfetti() {
            confetti({
                particleCount: 180,
                spread: 120,
                origin: { y: 0.6 },
                zIndex: 10001 // üî• DI ATAS overlay (9999)
            });

            setTimeout(() => {
                confetti({
                    particleCount: 120,
                    spread: 160,
                    origin: { y: 0.7 },
                    zIndex: 10001
                });
            }, 800);
            setTimeout(() => {
                confetti({
                    particleCount: 120,
                    spread: 160,
                    origin: { y: 0.7 },
                    zIndex: 10001
                });
            }, 1800);
        }

        function nextPrize() {
            $('#nextPrizeBtn').prop('disabled', true);
            drawCurrentPrize();
        }

        function stopAllSounds() {
            const drum = $('#drumSound')[0];
            const win = $('#winSound')[0];

            if (drum) {
                drum.pause();
                drum.currentTime = 0;
            }

            if (win) {
                win.pause();
                win.currentTime = 0;
            }
        }
        function toggleAudience() {
            $('body').toggleClass('audience-mode');

            const isAudience = $('body').hasClass('audience-mode');
            $('#nameInput').prop('disabled', isAudience);


        }



        function getTotalParticipants() {
            let totalPeserta = parseNames($('#nameInput').val()).length;
            $('#totalPeserta').text(totalPeserta);
        }

        function hasWinner() {
            const winners = JSON.parse(localStorage.getItem(STORAGE_WINNER)) || {};
            return Object.values(winners).some(arr => arr.length > 0);
        }

        function lockParticipantInput() {
            $('#nameInput').prop('disabled', true);
            $('#saveBtn').prop('disabled', true);
        }

        function unlockParticipantInput() {
            $('#nameInput').prop('disabled', false);
            $('#saveBtn').prop('disabled', false);
        }

        function updateNextPrizeInfo() {
            const prize = prizeConfig[currentPrizeIndex];

            // üéâ Semua doorprize selesai
            if (!prize) {
                $('#nextPrizeInfo').html('üéâ Semua doorprize telah selesai');
                return;
            }

            // üî• 2 DOORPRIZE TERAKHIR (FINAL BERSAMA)
            if (currentPrizeIndex === prizeConfig.length - 2) {
                const prizeA = prizeConfig[currentPrizeIndex];
                const prizeB = prizeConfig[currentPrizeIndex + 1];

                $('#nextPrizeInfo').html(`
            üèÜ <strong>GRAND PRIZE</strong><br>
          
        `);
                return;
            }

            // üéÅ PRIZE NORMAL
            $('#nextPrizeInfo').html(`
        üéÅ Doorprize selanjutnya:
        <span class="text-dark fw-bold">
            Rp ${prize.label}
        </span>
        <small class="text-muted">
            (${prize.perSpin} orang)
        </small>
    `);
        }

        function exportWinners() {
            const winners = JSON.parse(localStorage.getItem(STORAGE_WINNER)) || {};

            if (Object.keys(winners).length === 0) {
                alert('Belum ada pemenang untuk diexport');
                return;
            }

            let rows = [];
            rows.push(['Kategori Doorprize', 'Nominal', 'Urutan', 'Nama Pemenang']);

            prizeConfig.forEach(cfg => {
                const list = winners[cfg.id] || [];
                list.forEach((name, index) => {
                    rows.push([
                        `Doorprize ${cfg.id}`,
                        `Rp ${cfg.label}`,
                        index + 1,
                        name
                    ]);
                });
            });

            downloadCSV(rows, `pemenang_doorprize_${new Date().toISOString().slice(0, 10)}.csv`);
        }

        function downloadCSV(rows, filename) {
            const separator = ';'; // ‚Üê PENTING untuk Excel Indonesia

            const csvContent = rows
                .map(r =>
                    r.map(v =>
                        `"${String(v).replace(/"/g, '""')}"`
                    ).join(separator)
                )
                .join('\n');

            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');

            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();

            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function showPhotoOverlay(prizeId) {
            const winners = JSON.parse(localStorage.getItem(STORAGE_WINNER)) || {};

            // === KHUSUS GRAND PRIZE (2 PRIZE TERAKHIR) ===
            const lastIndex = prizeConfig.length - 2;
            const prizeA = prizeConfig[lastIndex];
            const prizeB = prizeConfig[lastIndex + 1];

            if (prizeId === prizeA.id || prizeId === prizeB.id) {
                showPhotoOverlayDoubleFinal(prizeA, prizeB, winners);
                return;
            }

            // === NORMAL (SATU PRIZE) ===
            const prize = prizeConfig.find(p => p.id === prizeId);

            if (!prize || !winners[prizeId] || winners[prizeId].length === 0) {
                alert('Belum ada pemenang di kategori ini');
                return;
            }

            $('#photoCategory').html(`
        üí∞ Rp ${prize.label}
        <div style="font-size:18px; opacity:.85">
            ${winners[prizeId].length} Pemenang
        </div>
    `);

            const container = $('#photoNames').empty();
            winners[prizeId].forEach(name => {
                container.append(`<div class="photo-name">${name}</div>`);
            });

            $('#photoOverlay').removeClass('d-none');
        }
        function closePhotoOverlay() {
            $('#photoOverlay').addClass('d-none');
        }

        function isDoubleFinalPrize() {
            return currentPrizeIndex === prizeConfig.length - 2;
        }

        function drawDoubleFinalPrize() {
            if (isDrawing) return;
            isDrawing = true;

            const prizeA = prizeConfig[currentPrizeIndex];
            const prizeB = prizeConfig[currentPrizeIndex + 1];

            let names = parseNames($('#nameInput').val());

            if (names.length < 2) {
                alert('Peserta tidak mencukupi untuk final prize');
                isDrawing = false;
                return;
            }

            $('#drumSound')[0].play();

            // === SHUFFLE DRAMATIS ===
            let shuffleInterval = setInterval(() => {
                $('.card-participant')
                    .removeClass('shuffle')
                    .eq(Math.floor(Math.random() * names.length))
                    .addClass('shuffle');
            }, 80);

            setTimeout(() => {
                clearInterval(shuffleInterval);
                $('.card-participant').removeClass('shuffle');

                // ambil 2 pemenang
                const winners = [];
                for (let i = 0; i < 2; i++) {
                    const idx = Math.floor(Math.random() * names.length);
                    winners.push(names[idx]);
                    names.splice(idx, 1);
                }

                // update peserta
                $('#nameInput').val(names.join('\n'));
                localStorage.setItem(STORAGE_TEXT, names.join('\n'));

                // simpan winner
                let all = JSON.parse(localStorage.getItem(STORAGE_WINNER)) || {};
                all[prizeA.id] = [winners[0]];
                all[prizeB.id] = [winners[1]];
                localStorage.setItem(STORAGE_WINNER, JSON.stringify(all));

                renderParticipants();
                renderWinners();

                showDoubleFinalOverlay(
                    winners,
                    [prizeA.label, prizeB.label]
                );

                // lompat langsung ke END
                currentPrizeIndex += 2;
                currentSpin = 0;

                localStorage.setItem(STORAGE_STATE, JSON.stringify({
                    currentSpin,
                    currentPrizeIndex
                }));

                updateNextPrizeInfo();
                $('#nextPrizeBtn').prop('disabled', true);
                isDrawing = false;

            }, 6000); // FINAL lebih lama
        }

        function showDoubleFinalOverlay(winners, labels) {
            $('#winnerOverlay').fadeIn();
            $('#winnerName').html('');
            $('#winnerAll').html('');
            $('#selamat-kepada').hide();
            launchConfetti();
            $('#winSound')[0].play();

            $('#winnerAll').html(`
        <div style="
            font-size:3rem;
            font-weight:900;
            margin-bottom:50px;
            letter-spacing:4px;
        ">
            üèÜ GRAND PRIZE üèÜ
        </div>

        <!-- WINNER CARD 1 -->
        <div class="d-flex justify-content-evenly">
        <div style="
            margin:0 auto 40px;
            width:650px;
            padding:35px;
            border-radius:28px;
            background:linear-gradient(135deg,#1e293b,#020617);
           box-shadow: 0 0 35px rgba(230, 230, 230, 0.55);
border: 2px solid #e5e7eb;
        ">
            <div class="winner-name" style="font-size:4.8rem">
                ${winners[0]}
            </div>
            <div style="
                font-size:2.2rem;
                margin-top:20px;
                color:#fbbf24;
                font-weight:700;
            ">
                üí∞ Rp ${labels[0]}
            </div>
        </div>

        <!-- VERTICAL DIVIDER -->
        <div style="
            width:6px;
            margin:0 auto 40px;
            background:linear-gradient(
                180deg,
                transparent,
                #fbbf24,
                transparent
            );
        "></div>

        <!-- WINNER CARD 2 -->
        <div style="
            margin:0 auto;
            width:650px;
            padding:35px;
            border-radius:28px;
            background:linear-gradient(135deg,#1e293b,#020617);
            box-shadow:0 0 35px rgba(251,191,36,.45);
            border:2px solid #fbbf24;
        ">
            <div class="winner-name" style="font-size:4.8rem">
                ${winners[1]}
            </div>
            <div style="
                font-size:2.2rem;
                margin-top:20px;
                color:#fbbf24;
                font-weight:700;
            ">
                üí∞ Rp ${labels[1]}
            </div>
        </div>
        </div>
    `);

            $('#btn-close-overlay').removeClass('d-none');
        }

        function showPhotoOverlayDoubleFinal(prizeA, prizeB, winners) {
            const winnerA = winners[prizeA.id]?.[0];
            const winnerB = winners[prizeB.id]?.[0];

            if (!winnerA || !winnerB) {
                alert('Pemenang Grand Prize belum lengkap');
                return;
            }

            $('#photoCategory').html(`
        üèÜ GRAND PRIZE üèÜ
    `);

            $('#photoNames').html(`
        <div class="d-flex justify-content-evenly w-100">

            <!-- SILVER -->
            <div style="
                width:650px;
                padding:35px;
                border-radius:28px;
                background:linear-gradient(135deg,#1e293b,#020617);
                box-shadow:0 0 35px rgba(230,230,230,.55);
                border:2px solid #e5e7eb;
                text-align:center;
            ">
                <div style="
                    font-size:4rem;
                    font-weight:900;
                    letter-spacing:3px;
                    color:#e5e7eb;
                ">
                    ${winnerA}
                </div>
                <div style="
                    font-size:2rem;
                    margin-top:20px;
                    font-weight:700;
                    color:#cbd5e1;
                ">
                    üí∞ Rp ${prizeA.label}
                </div>
            </div>

            <!-- DIVIDER -->
            <div style="
                width:6px;
                background:linear-gradient(
                    180deg,
                    transparent,
                    #fbbf24,
                    transparent
                );
            "></div>

            <!-- GOLD -->
            <div style="
                width:650px;
                padding:35px;
                border-radius:28px;
                background:linear-gradient(135deg,#1e293b,#020617);
                box-shadow:0 0 35px rgba(251,191,36,.45);
                border:2px solid #fbbf24;
                text-align:center;
            ">
                <div style="
                    font-size:4rem;
                    font-weight:900;
                    letter-spacing:3px;
                    color:#fbbf24;
                ">
                    ${winnerB}
                </div>
                <div style="
                    font-size:2rem;
                    margin-top:20px;
                    font-weight:700;
                    color:#fbbf24;
                ">
                    üí∞ Rp ${prizeB.label}
                </div>
            </div>

        </div>
    `);

            $('#photoOverlay').removeClass('d-none');
        }

    </script>

</body>

</html>